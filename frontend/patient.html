<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Care+ — Patient Care Record</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .subsection { margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; }
    .row input, .row select { margin-right: 8px; }
  </style>
</head>

<body>

<header>
  <a href="index.html" class="button">← Back</a>
  <h1 id="patientHeader">Patient</h1>
</header>

<main>

  <!-- NEW PATIENT FORM -->
  <section id="newPatientForm" class="card" style="display:none;">
    <h2>Create New Patient</h2>

    <div class="row">
      <input id="newName" placeholder="Full Name" />
      <input id="newAge" type="number" placeholder="Age" />
      <select id="newGender">
        <option value="">Gender</option>
        <option>Male</option>
        <option>Female</option>
      </select>
      <input id="newContact" placeholder="Contact" />
      <select id="newType">
        <option value="T2D">Type 2 Diabetes</option>
        <option value="T1D">Type 1 Diabetes</option>
      </select>
    </div>

    <button id="createPatientBtn" class="button">Save Patient</button>
  </section>

  <!-- EXISTING PATIENT INFO -->
  <section id="profileSection" class="card">
    <h2>Patient Information</h2>
    <p><b>Name:</b> <span id="pName">–</span></p>
    <p><b>Age:</b> <span id="pAge">–</span></p>
    <p><b>Gender:</b> <span id="pGender">–</span></p>
    <p><b>Contact:</b> <span id="pContact">–</span></p>
    <p><b>Diabetes Type:</b> <span id="pType">–</span></p>
    <p><b>Total Readings:</b> <span id="pTotal">–</span></p>
    <p><b>Alerts:</b> <span id="pAlerts">–</span></p>
  </section>

  <!-- GLUCOSE LOGGING -->
  <section id="logSection" class="card">
    <h2>Log Glucose Reading</h2>
    <div class="row">
      <input id="value" type="number" placeholder="mg/dL (e.g. 120)" />
      <select id="context">
        <option value="random">Random</option>
        <option value="fasting">Fasting</option>
        <option value="pre_meal">Pre-meal</option>
        <option value="post_meal">Post-meal</option>
      </select>
      <button id="saveReadingBtn" class="button">Save</button>
    </div>
  </section>

  <!-- HEART RATE -->
  <section class="card">
    <h2>Log Heart Rate</h2>
    <div class="row">
      <input id="hrValue" type="number" placeholder="BPM (e.g. 78)" />
      <button id="saveHrBtn" class="button">Save</button>
    </div>
    <div id="hrList"></div>
  </section>

  <!-- BLOOD PRESSURE -->
  <section class="card">
    <h2>Log Blood Pressure</h2>
    <div class="row">
      <input id="bpSys" type="number" placeholder="Systolic (e.g. 120)" />
      <input id="bpDia" type="number" placeholder="Diastolic (e.g. 80)" />
      <button id="saveBpBtn" class="button">Save</button>
    </div>
    <div id="bpList"></div>
  </section>

  <!-- RECENT GLUCOSE READINGS -->
  <section class="card">
    <h2>Recent Glucose Readings</h2>
    <div id="readingList"></div>
  </section>

  <!-- ALERTS -->
  <section class="card">
    <h2>Alerts</h2>
    <div id="alertList"></div>
  </section>

  <!-- MEDICATIONS -->
  <section class="card">
    <h2>Medications</h2>
    <div id="medList"></div>
    <hr>

    <h3>Add Medication</h3>
    <div id="medRows">
      <div class="row med-row">
        <input class="medName" placeholder="Name (e.g. Metformin)" />
        <input class="medDose" placeholder="Dose (e.g. 500mg)" />
        <input class="medFreq" placeholder="Frequency (e.g. 2× daily)" />
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="addMedRowBtn" class="button secondary">+ Add Row</button>
      <button id="saveMedsBtn" class="button">Save Medications</button>
    </div>
  </section>

</main>

<script src="app.js"></script>
<script>
const params = new URLSearchParams(location.search);
const id = params.get("id");
const isNew = params.get("new") === "1";

//
// NEW PATIENT MODE
//
if (isNew) {
  document.getElementById("newPatientForm").style.display = "block";
  document.getElementById("profileSection").style.display = "none";
  document.getElementById("logSection").style.display = "none";
}

document.getElementById("createPatientBtn")?.addEventListener("click", async () => {
  const name = document.getElementById("newName").value;
  if (!name) return alert("Name required");

  const created = await api("/patients", {
    method: "POST",
    body: {
      name,
      age: document.getElementById("newAge").value,
      gender: document.getElementById("newGender").value,
      contact: document.getElementById("newContact").value,
      diabetes_type: document.getElementById("newType").value
    }
  });

  location.href = `patient.html?id=${created.id}`;
});

//
// EXISTING PATIENT MODE
//
async function loadProfile() {
  if (isNew) return;

  const p = await api(`/patients/${id}`);

  document.getElementById("patientHeader").textContent = p.name;
  document.getElementById("pName").textContent = p.name;
  document.getElementById("pAge").textContent = p.age ?? "–";
  document.getElementById("pGender").textContent = p.gender ?? "–";
  document.getElementById("pContact").textContent = p.contact ?? "–";
  document.getElementById("pType").textContent = p.diabetes_type;

  const rs = await api(`/patients/${p.id}/readings`);
  const as = await api(`/patients/${p.id}/alerts`);

  document.getElementById("pTotal").textContent = rs.length;
  document.getElementById("pAlerts").textContent = as.length;
}

//
// READINGS
//
async function loadReadings() {
  if (isNew) return;
  const readings = await api(`/patients/${id}/readings`);
  document.getElementById("readingList").innerHTML = readings
    .map(r => `<div class="list-row">${new Date(r.timestamp).toLocaleString()} — <b>${r.value_mgdl}</b> mg/dL (${r.context})</div>`)
    .join("");
}

document.getElementById("saveReadingBtn")?.addEventListener("click", async () => {
  const value = +document.getElementById("value").value;
  const context = document.getElementById("context").value;
  if (!value) return alert("Enter glucose value");

  await api("/readings", {
    method: "POST",
    body: { patient_id: +id, value_mgdl: value, context }
  });

  loadReadings();
  loadProfile();
});

//
// HEART RATE
//
async function loadHeartRate() {
  if (isNew) return;
  const hr = await api(`/patients/${id}/heartrate`);
  document.getElementById("hrList").innerHTML = hr
    .map(h => `<div class="list-row">${new Date(h.timestamp).toLocaleString()} — <b>${h.bpm}</b> BPM</div>`)
    .join("");
}

document.getElementById("saveHrBtn")?.addEventListener("click", async () => {
  const bpm = +document.getElementById("hrValue").value;
  if (!bpm) return alert("Enter HR");

  await api(`/patients/${id}/heartrate`, {
    method: "POST",
    body: { bpm }
  });

  loadHeartRate();
});

//
// BLOOD PRESSURE
//
async function loadBP() {
  if (isNew) return;
  const bp = await api(`/patients/${id}/bloodpressure`);
  document.getElementById("bpList").innerHTML = bp
    .map(b => `<div class="list-row">${new Date(b.timestamp).toLocaleString()} — <b>${b.systolic}/${b.diastolic}</b> mmHg</div>`)
    .join("");
}

document.getElementById("saveBpBtn")?.addEventListener("click", async () => {
  const sys = +document.getElementById("bpSys").value;
  const dia = +document.getElementById("bpDia").value;
  if (!sys || !dia) return alert("Enter BP");

  await api(`/patients/${id}/bloodpressure`, {
    method: "POST",
    body: { systolic: sys, diastolic: dia }
  });

  loadBP();
});

//
// MEDICATIONS
//
async function loadMeds() {
  if (isNew) return;
  const meds = await api(`/patients/${id}/medications`);

  document.getElementById("medList").innerHTML = meds.length
    ? meds.map(m => `<div class="list-row"><b>${m.name}</b> — ${m.dosage} (${m.frequency}) <button class="button danger small" onclick="deleteMed(${m.id})">x</button></div>`).join("")
    : "<p>No medications yet.</p>";
}

window.deleteMed = async medId => {
  await api(`/medications/${medId}`, { method: "DELETE" });
  loadMeds();
};

document.getElementById("addMedRowBtn")?.addEventListener("click", () => {
  const box = document.querySelector(".med-row");
  const clone = box.cloneNode(true);
  clone.querySelectorAll("input").forEach(x => x.value = "");
  document.getElementById("medRows").appendChild(clone);
});

document.getElementById("saveMedsBtn")?.addEventListener("click", async () => {
  for (const r of document.querySelectorAll(".med-row")) {
    const name = r.querySelector(".medName").value;
    if (!name) continue;

    await api(`/patients/${id}/medications`, {
      method: "POST",
      body: {
        name,
        dosage: r.querySelector(".medDose").value,
        frequency: r.querySelector(".medFreq").value
      }
    });
  }
  loadMeds();
});

//
// ALERTS
//
async function loadAlerts() {
  if (isNew) return;
  const alerts = await api(`/patients/${id}/alerts`);
  document.getElementById("alertList").innerHTML = alerts
    .map(a => `<div class="list-row"><span class="badge ${a.severity}">${a.severity}</span> ${new Date(a.timestamp).toLocaleString()} — ${a.message}</div>`)
    .join("");
}

//
// INIT
//
window.addEventListener("DOMContentLoaded", async () => {
  await loadProfile();
  await loadReadings();
  await loadHeartRate();
  await loadBP();
  await loadAlerts();
  await loadMeds();
});
</script>

</body>
</html>
